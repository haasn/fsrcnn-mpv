//!HOOK LUMA
//!DESC feature map
//!BIND HOOKED
//!SAVE FEATURES
//!COMPONENTS 4

vec4 hook()
{
    vec4 feature = vec4(-0.00886457692832, -0.00483089499176, 0.148162215948, 0.0272942371666);

    feature += vec4(-0.0438778102398, 0.0218669418246, 0.0264104735106, -0.0123165119439) * HOOKED_texOff(vec2(-2, -2)).xxxx;
    feature += vec4(0.0344593413174, 0.0355685949326, 0.00359983183444, -0.0550974607468) * HOOKED_texOff(vec2(-2, -1)).xxxx;
    feature += vec4(-0.141739219427, 0.0826197937131, 0.136241704226, 0.101086564362) * HOOKED_texOff(vec2(-2, 0)).xxxx;
    feature += vec4(0.0432096794248, 0.000396780727897, 0.0448036417365, 0.00742272567004) * HOOKED_texOff(vec2(-2, 1)).xxxx;
    feature += vec4(0.102353803813, 0.0230003613979, 0.00523625733331, -0.0294737871736) * HOOKED_texOff(vec2(-2, 2)).xxxx;

    feature += vec4(0.023399380967, 0.0146378371865, 0.0117366220802, -0.0220789331943) * HOOKED_texOff(vec2(-1, -2)).xxxx;
    feature += vec4(-0.0445792526007, -0.00159452925436, 0.0794737711549, 0.066229224205) * HOOKED_texOff(vec2(-1, -1)).xxxx;
    feature += vec4(0.018363205716, -0.100366316736, 0.10015399754, -0.0177555903792) * HOOKED_texOff(vec2(-1, 0)).xxxx;
    feature += vec4(-0.034572891891, -0.0106960590929, 0.0261787064373, 0.0508790165186) * HOOKED_texOff(vec2(-1, 1)).xxxx;
    feature += vec4(-0.051618244499, 0.0373560637236, 0.0561593137681, -0.0383656583726) * HOOKED_texOff(vec2(-1, 2)).xxxx;

    feature += vec4(0.0327723436058, 0.081143707037, 0.0260361097753, 0.0511669553816) * HOOKED_texOff(vec2(0, -2)).xxxx;
    feature += vec4(-0.0262435246259, -0.137421473861, 0.0632160827518, 0.0179958026856) * HOOKED_texOff(vec2(0, -1)).xxxx;
    feature += vec4(-0.00983286928385, 1.23122632504, -0.479972332716, 1.1608453989) * HOOKED_texOff(vec2(0, 0)).xxxx;
    feature += vec4(-0.00655845645815, -0.120231546462, 0.133179977536, 0.0351167581975) * HOOKED_texOff(vec2(0, 1)).xxxx;
    feature += vec4(-0.0300472341478, 0.0331439189613, -0.00572661357, 0.0991264730692) * HOOKED_texOff(vec2(0, 2)).xxxx;

    feature += vec4(-0.0553337857127, 0.0143132843077, -0.0126999663189, -0.04738509655) * HOOKED_texOff(vec2(1, -2)).xxxx;
    feature += vec4(0.0282985847443, 0.0520521774888, 0.060180105269, -0.0218068230897) * HOOKED_texOff(vec2(1, -1)).xxxx;
    feature += vec4(-0.0559655837715, -0.135638535023, 0.124812573195, 0.070796482265) * HOOKED_texOff(vec2(1, 0)).xxxx;
    feature += vec4(-0.0194083787501, -0.0113721052185, 0.0453431531787, 0.0562542192638) * HOOKED_texOff(vec2(1, 1)).xxxx;
    feature += vec4(-0.0195454917848, 0.022623764351, 0.0387756302953, -0.0172457080334) * HOOKED_texOff(vec2(1, 2)).xxxx;

    feature += vec4(0.0348000116646, -0.0226845890284, -0.0293635576963, 0.0117758847773) * HOOKED_texOff(vec2(2, -2)).xxxx;
    feature += vec4(-0.0538412816823, 0.0161512866616, 0.0100569007918, -0.0326526239514) * HOOKED_texOff(vec2(2, -1)).xxxx;
    feature += vec4(0.0188723076135, 0.0911628678441, -0.00089679955272, 0.00430206302553) * HOOKED_texOff(vec2(2, 0)).xxxx;
    feature += vec4(-0.00346153927967, 0.0222660414875, 0.0310884844512, -0.0212568137795) * HOOKED_texOff(vec2(2, 1)).xxxx;
    feature += vec4(0.0109416712075, 0.0361104086041, 0.0210069324821, -0.0361080206931) * HOOKED_texOff(vec2(2, 2)).xxxx;

    feature = mix(feature, vec4(0.00881294719875, 0.0301210992038, 0.0423631183803, 0.0395227335393) * feature, lessThan(feature, vec4(0.0)));
    return feature;
}

//!HOOK LUMA
//!DESC shrinking
//!BIND FEATURES
//!SAVE MODEL
//!COMPONENTS 2

vec4 hook()
{
    vec2 model = vec2(-0.426695048809, 0.347394198179);

    vec4 feature = FEATURES_tex(FEATURES_pos);
    model += vec2(-0.288370102644, -0.240694642067) * feature.x;
    model += vec2(0.965256631374, -0.492584973574) * feature.y;
    model += vec2(-0.434856414795, 0.246492579579) * feature.z;
    model += vec2(0.665271162987, -0.708780407906) * feature.w;

    model = mix(model, vec2(0.466272115707, 0.0853745639324) * model, lessThan(model, vec2(0.0)));
    return vec4(model, vec2(0.0));
}

//!HOOK LUMA
//!DESC mapping
//!BIND MODEL
//!SAVE MODEL
//!COMPONENTS 2

vec4 hook()
{
    vec2 m_out = vec2(0.288623064756, 0.179249316454);
    vec2 m_in;

    m_in = MODEL_texOff(vec2(-1, -1)).xy;
    m_out += vec2(0.0360559336841, -0.00178868800867) * m_in.x;
    m_out += vec2(0.17033649981, -0.0508018732071) * m_in.y;
    m_in = MODEL_texOff(vec2(-1, 0)).xy;
    m_out += vec2(-0.143693849444, 0.0806971415877) * m_in.x;
    m_out += vec2(-0.00463935546577, 0.17884491384) * m_in.y;
    m_in = MODEL_texOff(vec2(-1, 1)).xy;
    m_out += vec2(0.0250843688846, -0.0137267112732) * m_in.x;
    m_out += vec2(0.0863914862275, -0.0632653087378) * m_in.y;

    m_in = MODEL_texOff(vec2(0, -1)).xy;
    m_out += vec2(-0.147743701935, 0.100699163973) * m_in.x;
    m_out += vec2(-0.0414614230394, 0.103857569396) * m_in.y;
    m_in = MODEL_texOff(vec2(0, 0)).xy;
    m_out += vec2(1.06275629997, -0.675453126431) * m_in.x;
    m_out += vec2(-0.225764840841, 0.569409489632) * m_in.y;
    m_in = MODEL_texOff(vec2(0, 1)).xy;
    m_out += vec2(-0.133118599653, 0.128260374069) * m_in.x;
    m_out += vec2(0.101189151406, 0.251569926739) * m_in.y;

    m_in = MODEL_texOff(vec2(1, -1)).xy;
    m_out += vec2(0.0331527963281, 0.0068460595794) * m_in.x;
    m_out += vec2(0.124783158302, 0.0831766799092) * m_in.y;
    m_in = MODEL_texOff(vec2(1, 0)).xy;
    m_out += vec2(-0.13651317358, 0.107196234167) * m_in.x;
    m_out += vec2(0.076734021306, 0.202287867665) * m_in.y;
    m_in = MODEL_texOff(vec2(1, 1)).xy;
    m_out += vec2(0.0285350326449, -0.0182138066739) * m_in.x;
    m_out += vec2(0.10200265795, -0.0452295467257) * m_in.y;

    m_out = mix(m_out, vec2(0.12461514771, 0.500106453896) * m_out, lessThan(m_out, vec2(0.0)));
    return vec4(m_out, vec2(0.0));
}

//!HOOK LUMA
//!DESC expansion
//!BIND MODEL
//!SAVE EXPANDED
//!COMPONENTS 4

vec4 hook()
{
    vec4 expanded = vec4(-0.544858276844, 0.234514191747, -0.0339564569294, -0.0704471841455);

    vec2 model = MODEL_tex(MODEL_pos).xy;
    expanded += vec4(0.943406283855, 0.125708475709, -0.193366408348, -0.168442100286) * model.x;
    expanded += vec4(-0.700045704842, -0.174264341593, 0.363390028477, 0.259187221527) * model.y;

    expanded = mix(expanded, vec4(0.837689876556, -0.00293831247836, 0.0234151631594, 0.00964965391904) * expanded, lessThan(expanded, vec4(0.0)));
    return expanded;
}

//!HOOK LUMA
//!DESC deconvolution
//!BIND EXPANDED
//!SAVE LUMA
//!WIDTH HOOKED.w 3 *
//!HEIGHT HOOKED.h 3 *
//!COMPONENTS 1

vec4 hook()
{
    vec2 fcoord = fract(EXPANDED_pos * EXPANDED_size);
    vec2 base = EXPANDED_pos + (vec2(0.5) - fcoord) * EXPANDED_pt;
    ivec2 index = 2 - ivec2(fcoord * vec2(3));

    float res = 0.400902688503;

    res += dot(vec4[](
        vec4(0.0300590246916, 0.00402098009363, 0.00471992185339, 0.0128630930558),
        vec4(0.0207914244384, 0.0109554547817, 0.00401777448133, 0.0121963014826),
        vec4(-0.0127619719133, 0.0253674499691, 0.00476060761139, 0.0119819259271),
        vec4(0.0106960143894, 0.013466139324, 0.0135443424806, 0.0178537871689),
        vec4(0.0136137995869, 0.0245900787413, 0.00924944318831, 0.015656368807),
        vec4(0.00480147916824, 0.0396899282932, 0.00839684531093, 0.0140550602227),
        vec4(-0.0283670015633, 0.026010915637, 0.0298371259123, 0.0262305531651),
        vec4(-0.00521721644327, 0.039237935096, 0.0186355262995, 0.0213932394981),
        vec4(0.0348034091294, 0.0479133762419, 0.00639391085133, 0.0140516106039)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(-1, -1)));

    res += dot(vec4[](
        vec4(-0.00129836425185, 0.0624179132283, 0.0132874147967, 0.00601163320243),
        vec4(-0.0264668427408, 0.0696350410581, 0.010291216895, 0.00859394483268),
        vec4(-0.0147577375174, 0.0667239800096, 0.0133547130972, 0.00993559975177),
        vec4(0.0573914200068, 0.050032787025, 0.00982359051704, 0.00435302965343),
        vec4(0.0375122688711, 0.0548326037824, -0.000584516208619, 0.0048745861277),
        vec4(0.0351890027523, 0.0561302192509, 0.00467381905764, 0.00528236525133),
        vec4(0.165142461658, 0.019654918462, -0.00151733646635, -0.00222930894233),
        vec4(0.168069988489, 0.0190563201904, -0.00931407045573, 0.000538081279956),
        vec4(0.139982253313, 0.0273730847985, -0.00694281188771, 0.00117864564527)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(-1, 0)));

    res += dot(vec4[](
        vec4(-0.0123449098319, 0.0297171417624, 0.0340763479471, 0.0322474017739),
        vec4(0.023577189073, 0.0148969832808, 0.026651006192, 0.0262956283987),
        vec4(0.0388096831739, 0.0038710818626, 0.0279357135296, 0.0259428285062),
        vec4(-0.00039624015335, 0.0466080456972, 0.0357018969953, 0.0329909399152),
        vec4(0.0160381048918, 0.0293419957161, 0.0289538446814, 0.0281253308058),
        vec4(0.0244057681412, 0.0125385569409, 0.0354672670364, 0.029714025557),
        vec4(0.0264215376228, 0.058510068804, 0.0423205085099, 0.0371852554381),
        vec4(-0.00360717764124, 0.0464953891933, 0.0405361093581, 0.0349715687335),
        vec4(-0.01470586285, 0.0272374730557, 0.0454678162932, 0.0359832234681)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(-1, 1)));

    res += dot(vec4[](
        vec4(-0.012529364787, 0.0663314983249, 0.0416601784527, 0.0187576469034),
        vec4(0.0520477667451, 0.0567371174693, 0.00399134261534, 3.05198300339e-05),
        vec4(0.177495077252, 0.0241264794022, -0.046215031296, -0.025083411485),
        vec4(-0.0304935202003, 0.0694402232766, 0.0374496690929, 0.0189691353589),
        vec4(0.0397892333567, 0.0572022795677, -0.000292196753435, 0.000432643078966),
        vec4(0.182731688023, 0.0226216763258, -0.0606992281973, -0.0273759234697),
        vec4(-0.0122038852423, 0.0643357858062, 0.018200526014, 0.00800641998649),
        vec4(0.0451395437121, 0.0564513094723, -0.00556256016716, -0.00368832820095),
        vec4(0.162484481931, 0.029202003032, -0.0612515099347, -0.0280180256814)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(0, -1)));

    res += dot(vec4[](
        vec4(0.367527991533, 0.0189054924995, -0.0673271566629, -0.0540054738522),
        vec4(0.414703339338, 0.00445130327716, -0.0539013892412, -0.0440158694983),
        vec4(0.352110624313, 0.024565583095, -0.0613323152065, -0.047643493861),
        vec4(0.407517135143, 0.00621781405061, -0.0768092125654, -0.0519848428667),
        vec4(0.473806083202, -0.0126233268529, -0.0506568364799, -0.0378747284412),
        vec4(0.407592773438, 0.00630854256451, -0.0592569373548, -0.0466999560595),
        vec4(0.352571278811, 0.024929817766, -0.0886681303382, -0.0595128200948),
        vec4(0.413764238358, 0.00622550724074, -0.0742565244436, -0.0525106266141),
        vec4(0.366961032152, 0.0199336577207, -0.0655834823847, -0.054882414639)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(0, 0)));

    res += dot(vec4[](
        vec4(0.159858956933, 0.0296562835574, -0.0424389392138, -0.0176517795771),
        vec4(0.0435136109591, 0.0559335276484, -0.0134485606104, -0.00453060353175),
        vec4(-0.0144555894658, 0.0637911260128, 0.0126213217154, 0.00737520493567),
        vec4(0.182339504361, 0.0207491852343, -0.0401641279459, -0.0155914705247),
        vec4(0.0401279255748, 0.0537224635482, -0.00480281421915, -0.000126970437123),
        vec4(-0.0315106995404, 0.0669003427029, 0.0311490185559, 0.0153981661424),
        vec4(0.17758217454, 0.0235287062824, -0.0304804872721, -0.0170450340956),
        vec4(0.0528185963631, 0.0522740334272, -0.000865759036969, -0.00351467984729),
        vec4(-0.0146344564855, 0.0642981305718, 0.0321087539196, 0.0123334946111)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(0, 1)));

    res += dot(vec4[](
        vec4(-0.0129130724818, 0.0231010410935, 0.0309292264283, 0.0262299086899),
        vec4(-0.00212957151234, 0.0430558696389, 0.0279256142676, 0.0254387874156),
        vec4(0.0259018819779, 0.0580419749022, 0.0145005406812, 0.0214565768838),
        vec4(0.0240904204547, 0.0106589039788, 0.0197468362749, 0.0177804101259),
        vec4(0.0158850438893, 0.0289175081998, 0.0164044164121, 0.017552241683),
        vec4(-0.0032007212285, 0.0463505089283, 0.0171841308475, 0.0181936658919),
        vec4(0.0389749631286, 0.00383215770125, 0.0190273448825, 0.0161647666246),
        vec4(0.0232891645283, 0.0163963120431, 0.0166201218963, 0.0160764083266),
        vec4(-0.0149458767846, 0.0312223155051, 0.0218314491212, 0.0198332946748)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(1, -1)));

    res += dot(vec4[](
        vec4(0.138327002525, 0.0233498550951, -0.0393504649401, -0.0157099999487),
        vec4(0.168781131506, 0.0127306906506, -0.0359156243503, -0.0137959746644),
        vec4(0.165888950229, 0.0110493972898, -0.0199858937413, -0.0141029311344),
        vec4(0.0344230420887, 0.0501553975046, -0.0039411848411, -0.00498077087104),
        vec4(0.0389047190547, 0.045630287379, -0.00581060163677, -0.00510866101831),
        vec4(0.0566900484264, 0.0407445318997, -0.00196485547349, -0.00885317008942),
        vec4(-0.0156563799828, 0.0603873208165, 0.0208653640002, 0.00478432700038),
        vec4(-0.024841196835, 0.0612302720547, 0.018267294392, 0.0038704671897),
        vec4(-0.000897794670891, 0.0545547269285, 0.0155072398484, -0.000415022543166)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(1, 0)));

    res += dot(vec4[](
        vec4(0.0375876091421, 0.0501545146108, 0.00316297519021, 0.00965205579996),
        vec4(-0.00369403557852, 0.0421684384346, 0.00580439250916, 0.0107563883066),
        vec4(-0.0296973045915, 0.029119797051, 0.0135628860444, 0.0144343357533),
        vec4(0.00560544058681, 0.0431138537824, 0.00193804968148, 0.00714849401265),
        vec4(0.0127347717062, 0.0301073845476, -0.00190594198648, 0.0055239899084),
        vec4(0.0111742001027, 0.017146198079, -0.000247619580477, 0.00652350625023),
        vec4(-0.0113886808977, 0.0290119610727, 0.000796404725406, 0.00539378309622),
        vec4(0.0201342888176, 0.0155374985188, -0.00273191765882, 0.00307217007503),
        vec4(0.0326254405081, 0.00588187994435, -0.00445386627689, 0.00342170288786)
    )[index.x * 3 + index.y], EXPANDED_tex(base + EXPANDED_pt * vec2(1, 1)));

    return vec4(res, 0, 0, 1);
}
